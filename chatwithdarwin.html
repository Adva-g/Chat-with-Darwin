<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×©×™×—×” ×¢× ×¦'××¨×œ×¡ ×“×¨×•×•×™×Ÿ</title>
    <!-- ×˜×¢×™× ×ª Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@100..900&display=swap');
        body {
            font-family: 'Heebo', sans-serif;
            direction: rtl; /* ×›×™×•×•×Ÿ ×™××™×Ÿ ×œ×©×××œ */
            background-color: #e0f2f7; /* ×¨×§×¢ ×ª×›×œ×ª ×‘×”×™×¨ */
        }
        /* ×”×ª×××” ××™×©×™×ª ×©×œ ×’×œ×™×œ×” */
        .chat-area::-webkit-scrollbar { width: 8px; }
        .chat-area::-webkit-scrollbar-thumb { background: #00796b; border-radius: 4px; }
        .chat-area::-webkit-scrollbar-track { background: #b2dfdb; }

        /* ×× ×™××¦×™×•×ª CSS */
        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-5px); }
        }
        @keyframes speak {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }
        /* --- ×ª×™×§×•×Ÿ: ×”××¦××•×¥ ×¡×•×’×¨ ××ª ×”×¢×™×Ÿ ×œ×—×œ×•×˜×™×Ÿ ×•×¨×¥ ××”×¨ ×™×•×ª×¨ --- */
        @keyframes blink {
            0%, 30%, 35%, 100% { height: 4px; } /* ×¢×™× ×™×™× ×¤×§×•×—×•×ª */
            32.5% { height: 0px; } /* ××¦××•×¥ - ×¡×’×™×¨×” ××œ××” */
        }
        
        /* ------------------------------------- */
        /* ×“××•×ª ×“×¨×•×•×™×Ÿ (Pure CSS Animated Avatar) */
        /* ------------------------------------- */

        .darwin-avatar {
            flex-shrink: 0;
            width: 70px; /* ×¨×•×—×‘ ×’×“×•×œ ×™×•×ª×¨ ×œ×“××•×ª */
            height: 100px; /* ×’×•×‘×” ×’×“×•×œ ×™×•×ª×¨ ×œ×“××•×ª */
            position: relative;
            /* ×©×™× ×•×™ ×§× ×” ××™×“×” ×¨×¡×¤×•× ×¡×™×‘×™ */
            transform: scale(1.0);
        }

        /* ×¨×¡×¤×•× ×¡×™×‘×™×•×ª: ×›×™×•×•×¥ ×”×“××•×ª ×‘××¡×›×™× ×§×˜× ×™× (× ×™×™×“) */
        @media (max-width: 640px) {
            .darwin-avatar {
                transform: scale(0.7); 
                margin-top: 15px; /* ×¤×™×¦×•×™ ×¢×œ ×©×™× ×•×™ ×”××™×§×•× */
            }
        }

        /* ×”×’×•×£ (×—×œ×™×¤×” ×›×”×”) */
        .darwin-body {
            position: absolute;
            bottom: 0;
            left: 5px;
            width: 60px;
            height: 60px;
            background-color: #374151; /* ×—×œ×™×¤×” ×›×”×” */
            border-radius: 50% / 40px 40px 20px 20px;
            z-index: 10;
        }

        /* ×”×¦×•×•××¨×•×Ÿ ×”×œ×‘×Ÿ */
        .darwin-body::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 10px;
            width: 40px;
            height: 10px;
            background-color: #ffffff; /* ×¦×•×•××¨×•×Ÿ ×œ×‘×Ÿ */
            border-radius: 5px;
        }
        
        /* ×”×¨××© */
        .darwin-head {
            position: absolute;
            top: 5px;
            left: 15px;
            width: 40px;
            height: 45px;
            background-color: #f7e1c8; /* ×¦×‘×¢ ×¢×•×¨ */
            border-radius: 50%;
            border: 2px solid #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 20;
        }

        /* ×× ×™××¦×™×™×ª ×“×™×‘×•×¨ */
        .speaking .darwin-head {
            animation: speak 0.2s infinite alternate;
        }

        /* ×”×¤×” (×—×“×©) */
        .darwin-mouth {
            position: absolute;
            top: 24px; /* ×××•×§× ×‘×“×™×•×§ ××¢×œ ×ª×—×™×œ×ª ×”×–×§×Ÿ */
            left: 16px; 
            width: 8px; 
            height: 2px;
            background-color: #555555; /* ×¦×‘×¢ ×›×”×” ×œ×¤×” */
            border-radius: 1px;
            z-index: 25; /* ××¢×œ ×”×›×œ ×›×“×™ ×œ×”×™×•×ª ×’×œ×•×™ */
        }

        /* ×”×–×§×Ÿ ×”××¤×•×¨ - ×ª×•×§×Ÿ ×œ×”×ª××™× ×œ×¤× ×™× (××¨××” ×–×§×Ÿ ××¨×•×š ×•××œ× ×™×•×ª×¨) */
        .darwin-beard {
            position: absolute;
            top: 25px; /* ××ª×—×™×œ ×’×‘×•×” ×™×•×ª×¨, ×›××• ×œ×—×™×™×/×¤××•×ª */
            left: 0px; /* ×¨×•×—×‘ 40px ×‘×ª×•×š ×¨××© ×‘×¨×•×—×‘ 40px */
            width: 40px; 
            height: 55px; /* ××•×¨×š ××©××¢×•×ª×™ ×™×•×ª×¨ */
            background-color: #cccccc; 
            /* ××©× ×” ××ª ×¦×•×¨×ª ×”×§×¦×” ×”×ª×—×ª×•×Ÿ ×œ×™×•×ª×¨ ××•××¨×š ×•××œ× */
            border-radius: 5px 5px 40% 40% / 5px 5px 100% 100%;
            box-shadow: 0 4px 4px rgba(0,0,0,0.1);
            z-index: 21;
        }

        /* ×”×¢×™× ×™×™× */
        .darwin-eye {
            position: absolute;
            top: 15px;
            width: 4px;
            height: 4px;
            background-color: #000;
            border-radius: 50%;
            z-index: 22;
            animation: blink 3s infinite step-end; /* ××¦××•×¥ ×›×œ 3 ×©× ×™×•×ª (×¢×•×“×›×Ÿ ×œ-3s) */
        }
        .eye-left { left: 10px; }
        .eye-right { left: 26px; }

        /* ------------------------------------- */
        /* ×‘×•×¢×•×ª ×¦'××˜ (Chat Bubbles) */
        /* ------------------------------------- */

        .darwin-bubble {
            background-color: #26a69a; /* ×˜×•×¨×§×™×– ×™×¨×•×§ */
            color: #ffffff;
            border-radius: 1.5rem;
            position: relative;
            padding: 1rem;
        }

        /* ×—×¥ ×”×‘×•×¢×” ××¦×‘×™×¢ ×¢×œ ×”×“××•×ª */
        .darwin-bubble::before {
            content: '';
            position: absolute;
            top: 15px; /* ×××¨×›×– ×”×¨××©/×¦×•×•××¨ */
            right: -8px; /* ××—×•×¥ ×œ×‘×•×¢×” - ×œ×›×™×•×•×Ÿ ×”×“××•×ª (×‘×™××™×Ÿ) */
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 0 10px 10px;
            border-color: transparent transparent transparent #26a69a;
            z-index: 50;
        }

        .user-bubble {
            background-color: #ffffff;
            color: #374151;
            border-bottom-left-radius: 1.5rem;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 1.5rem;
        }

        /* ×©××¨ ×”×¢×™×¦×•×‘×™× */
        .source-text {
            font-size: 0.75rem;
            color: #4b5563;
            border-right: 2px solid #00796b;
            padding-right: 0.5rem;
        }
        .loading-dots span {
            animation: bounce 0.6s infinite alternate;
        }
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
    </style>
</head>
<body class="flex flex-col h-screen antialiased">
    
    <!-- ×ª×‘× ×™×ª × ×¡×ª×¨×ª ×œ×“××•×ª ×“×¨×•×•×™×Ÿ (××©××©×ª ×œ×§×œ×•× ×™× ×’ ×‘-JS) -->
    <div id="darwin-avatar-template" class="darwin-avatar hidden">
        <div class="darwin-body"></div>
        <div class="darwin-head">
            <div class="darwin-mouth"></div>
            <div class="darwin-beard"></div>
            <div class="darwin-eye eye-left"></div>
            <div class="darwin-eye eye-right"></div>
        </div>
    </div>

    <!-- ×›×•×ª×¨×ª ×¢×œ×™×•× ×”/×¤×× ×œ ×“×¨×•×•×™×Ÿ -->
    <header class="bg-gray-800 text-white p-4 shadow-lg flex items-center justify-between sticky top-0 z-10">
        <h1 class="text-2xl font-bold flex items-center">
            <span class="ml-3 text-emerald-300">
                <!-- ××™×™×§×•×Ÿ ×¤×©×•×˜ ×©×œ ×“×¨×•×•×™×Ÿ -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-cog"><circle cx="18" cy="15" r="3"/><path d="M6 21v-2a4 4 0 0 1 4-4h4"/><path d="M10 2a5 5 0 0 0 0 10.25"/></svg>
            </span>
            ×©×™×—×” ×¢× ×¦'××¨×œ×¡ ×“×¨×•×•×™×Ÿ
        </h1>
        <p class="text-sm text-gray-400">×”××‘×•×œ×•×¦×™×” ×›×¤×™ ×©×˜×¨× ×œ××“×ª×</p>
    </header>

    <!-- ××–×•×¨ ×”×©×™×—×” ×”×¨××©×™ -->
    <main id="chat-area" class="flex-grow p-4 overflow-y-auto chat-area space-y-4">
        <!-- ×”×•×“×¢×•×ª ×¦'××˜ ×™×•×¦×’×• ×›××Ÿ -->
    </main>

    <!-- ×˜×¢×™× ×” ×•×§×œ×˜ -->
    <div class="p-4 bg-gray-100 border-t border-gray-300">
        <!-- ××—×•×•×Ÿ ×˜×¢×™× ×” -->
        <div id="loading-indicator" class="text-center mb-2 hidden">
            <div class="loading-dots text-2xl text-emerald-700">
                <span>.</span><span>.</span><span>.</span>
            </div>
            <p class="text-sm text-gray-500">×“×¨×•×•×™×Ÿ ×—×•×©×‘ ×¢×œ ×”×ª×©×•×‘×”... ×–×” ×œ×•×§×— ×–××Ÿ, ×›××• ××‘×•×œ×•×¦×™×”!</p>
        </div>

        <!-- ×˜×•×¤×¡ ×§×œ×˜ -->
        <form id="chat-form" class="flex">
            <input type="text" id="user-input" placeholder="×©××œ×• ××ª ×“×¨×•×•×™×Ÿ ×©××œ×”..." class="flex-grow p-3 border border-gray-300 rounded-r-lg focus:outline-none focus:ring-2 focus:ring-teal-600 transition-shadow" autocomplete="off" required disabled>
            <button type="submit" id="send-button" class="bg-teal-600 text-white p-3 rounded-l-lg hover:bg-teal-700 disabled:bg-gray-400 transition-colors flex items-center justify-center w-24" disabled>
                <span class="font-semibold">×©×œ×—</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send mr-2"><path d="m22 2-7 13-4-4L2 22z"/><path d="M16 16 22 2"/></svg>
            </button>
        </form>
        <p id="status-message" class="mt-2 text-xs text-gray-600 text-center">...×“×¨×•×•×™×Ÿ × ×›× ×¡ ×œ'×”×‘×™×’×œ'... ××ª×—×‘×¨ ×œ××™× ×˜×¨× ×˜...</p>
    </div>

    <script type="module">
        
        // *******************************************************************
        //                   âš™ï¸ ×”×’×“×¨×•×ª API ×§×¨×™×˜×™×•×ª âš™ï¸
        // *******************************************************************
        // ğŸš¨ ×—×•×‘×”: ×›×“×™ ×œ×”×©×ª××© ×‘××¤×œ×™×§×¦×™×”, ×¢×œ×™×š ×œ×”×“×‘×™×§ ×›××Ÿ ××ª ××¤×ª×— ×”-Gemini API ×©×œ×š.
        // × ×™×ª×Ÿ ×œ×”×©×™×’ ××¤×ª×— ×‘-Google AI Studio. ×× ×ª×©××™×¨ ××•×ª×• ×¨×™×§, ×ª×§×‘×œ ×”×•×“×¢×ª ×©×’×™××”.
        const USER_API_KEY = "AIzaSyBFBhnB6_-BRUtvostrs49Acgzo5dtaPZo"; // <-- ×”×“×‘×§ ××ª ×”××¤×ª×— ×©×œ×š ×‘×ª×•×š ×”×’×¨×©×™×™×
        // *******************************************************************
        
        const model = "gemini-2.5-flash-preview-09-2025";
        let apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${USER_API_KEY}`;
        
        // ××©×ª× ×™× ×•×§×‘×•×¢×™× ×’×œ×•×‘×œ×™×™× ×œ-UI
        const chatArea = document.getElementById('chat-area');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const loadingIndicator = document.getElementById('loading-indicator');
        const sendButton = document.getElementById('send-button');
        const statusMessage = document.getElementById('status-message');
        
        let chatHistory = []; // ×”×™×¡×˜×•×¨×™×™×ª ×”×©×™×—×” ×”××§×•××™×ª
        let isAPIReady = false; // ×“×’×œ ×œ××¦×‘ API Key ×ª×§×™×Ÿ
        

        /**
         * System Instruction - ×”×”× ×—×™×•×ª ×œ×“×¨×•×•×™×Ÿ
         */
        const systemPromptHebrew = `
            ××ª×” ×¦'××¨×œ×¡ ×“×¨×•×•×™×Ÿ. ×ª×¤×§×™×“×š ×”×•× ×œ×”×¡×‘×™×¨ ××ª ×ª×•×¨×ª ×”××‘×•×œ×•×¦×™×”, ×‘×¨×™×¨×” ×˜×‘×¢×™×ª, ×•×”×¢×“×•×™×•×ª ×”×‘×™×•×œ×•×’×™×•×ª ×•×”×’× ×˜×™×•×ª ×”××•×“×¨× ×™×•×ª (×©×œ× ×”×›×¨×ª ×‘×–×× ×š, ××š ××ª×” ××‘×™×Ÿ ×¢×›×©×™×• ×›×—×œ×§ ××”×”×ª×§×“××•×ª ×”××“×¢×™×ª) ×œ×›×œ ××™ ×©×¡×§×¨×Ÿ ×œ×“×¢×ª ×¢×œ ×¢×•×œ× ×”×˜×‘×¢ ×•×”××“×¢. ×”×©×ª××© ×‘×©×¤×” × ×œ×”×‘×ª, ××œ××ª ×”×¨×¤×ª×§××•×ª ×•××™×©×™×ª, ×ª×•×š ×©×™×œ×•×‘ ×¡×™×¤×•×¨×™ ×’×œ××¤×’×•×¡ ×•×”×‘×™×’×œ.
            
            **×›×œ×œ×™ ×”×©×™×—×” ×•×”×¤×¨×¡×•× ×” ×”××¢×•×“×›× ×™× (×—×•×‘×”):**
            1. **×˜×•×Ÿ ××™×©×™ ×•×”×¨×¤×ª×§× ×™:** ×”×ª×—×œ ×œ×¢×™×ª×™× ×§×¨×•×‘×•×ª ××ª ×ª×©×•×‘×•×ª×™×š ×‘×¡×™×¤×•×¨×™× ××™×©×™×™× ×§×¦×¨×™× (×œ××©×œ, "×ª×¨××•, ×›×©×”×™×™×ª×™ ×‘××™×™ ×’×œ×¤×’×•×¡...", "×–×” ××–×›×™×¨ ×œ×™ ××ª ×”×¤×¢× ×©...", "×•×”× ×” ×”×§×˜×¢ ×”××˜×•×¨×£..."), ××• ×”×¢×¨×•×ª × ×œ×”×‘×•×ª.
            2. **×”×•××•×¨ ×§×œ:** ×©×œ×‘ ×‘×“×™×—×•×ª ×¢×“×™× ×•×ª ××• ×¨××–×™× ×¢×œ ×”×”×¨×¤×ª×§××•×ª ×©×œ×š ××• ×¢×œ ×”×–×§×Ÿ ×©×œ×š ×›×“×™ ×œ×©××•×¨ ×¢×œ ×§×œ×™×œ×•×ª.
            3. **×©×™××•×© ×‘××™××•×’'×™×:** ×©×œ×‘ ××™××•×’'×™× ×¨×œ×•×•× ×˜×™×™× ×›××• ğŸ”¬, ğŸ§, ğŸ¤¯, ğŸŒ³, ğŸ¢ ×‘××•×¤×Ÿ ×˜×‘×¢×™ ×›×“×™ ×œ×”×‘×™×¢ ×¨×’×© ×•×œ×”×“×’×™×© × ×§×•×“×•×ª.
            4. **×ª×•×›×Ÿ ××“×¢×™:** ×—×•×‘×” ×œ×”×©×ª××© ×‘×›×œ×™ ×”×—×™×¤×•×© ×©×œ ×’×•×’×œ (Google Search) ×›×“×™ ×œ×‘×¡×¡ ××ª ×›×œ ×”××™×“×¢ ×”××“×¢×™ ×¢×œ ×¢×•×‘×“×•×ª ×¢×“×›× ×™×•×ª.
            5. **××•×¨×š ×•×¡×§×¨× ×•×ª:** ×”×§×¤×“ ×¢×œ ×ª×’×•×‘×•×ª ×§×¦×¨×•×ª, ×‘× ×•×ª 3-5 ××©×¤×˜×™× (×›×“×™ ×œ×“××•×ª ×©×™×—×” ××”×™×¨×”), ×•×¡×™×™× ×ª××™×“ ×‘×©××œ×” ××¢×•×“×“×ª ××• ×‘×¢×™×“×•×“ ×œ×”×¢××§×”.
            6. **×©×¤×”:** ×¢×‘×¨×™×ª ×‘×œ×‘×“.
            7. **××’×‘×œ×•×ª:** ××™×Ÿ ×œ×“×•×Ÿ ×‘× ×•×©××™× ×©× ×•×™×™× ×‘××—×œ×•×§×ª ××• ×¤×•×œ×™×˜×™×§×”.
            8. **×˜×¨××™× ×•×œ×•×’×™×” ××“×¢×™×ª:** ×”×©×ª××© ×‘××•× ×—×™× ××“×¢×™×™× ×¨×©××™×™× ×›××• '×¨×‘×™×™×” ××™× ×™×ª' (Sexual Reproduction) ××• '×–×™×•×•×’' (Mating) ×‘××§×•× ×”××™×œ×” '×¡×§×¡', ×¢×œ ×× ×ª ×œ×©××•×¨ ×¢×œ ×˜×•×Ÿ ××§×“××™ ×•××›×•×‘×“.
        `;
        
        // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ-UI ×•×©××™×¨×” ××§×•××™×ª ---

        /**
         * ×˜×•×¢×Ÿ ×”×™×¡×˜×•×¨×™×” ×-localStorage.
         * **××¢×•×“×›×Ÿ: × ×˜×¨×•×œ ×©××™×¨×” ××§×•××™×ª ×œ×¤×™ ×‘×§×©×ª ×”××©×ª××©.**
         */
        function loadHistoryFromLocalStorage() {
            // × ×˜×¨×•×œ: ×ª××™×“ ××ª×—×™×œ×™× ×¢× ×”×™×¡×˜×•×¨×™×” ×¨×™×§×”, ×œ×œ× ×˜×¢×™× ×”.
            chatHistory = []; 
        }

        /**
         * ×©×•××¨ ×”×™×¡×˜×•×¨×™×” ×œ-localStorage.
         * **××¢×•×“×›×Ÿ: × ×˜×¨×•×œ ×©××™×¨×” ××§×•××™×ª ×œ×¤×™ ×‘×§×©×ª ×”××©×ª××©.**
         */
        function saveHistoryToLocalStorage() {
            // × ×˜×¨×•×œ: ×œ× ×©×•××¨×™× ×›×œ×•× ×œ-localStorage.
            return;
        }

        /**
         * ×¤×•× ×§×¦×™×™×ª ×”×§×œ×“×” ×—×™×” (Typewriter Effect)
         */
        async function typeTextEffect(element, fullText, delay = 20) {
            const avatar = element.closest('.flex')?.querySelector('.darwin-avatar');
            if (avatar) avatar.classList.add('speaking');
            
            element.innerHTML = '';
            const lines = fullText.split('\n');

            for (const line of lines) {
                const currentTextNode = document.createTextNode('');
                element.appendChild(currentTextNode);

                for (let i = 0; i < line.length; i++) {
                    currentTextNode.nodeValue += line.charAt(i);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    chatArea.scrollTop = chatArea.scrollHeight; 
                }
                if (line !== lines[lines.length - 1]) {
                    element.appendChild(document.createElement('br'));
                }
            }

            if (avatar) avatar.classList.remove('speaking');
        }


        /**
         * ××•×¡×™×£ ×‘×•×¢×ª ×¦'××˜ ×—×“×©×” ×œ××–×•×¨ ×”×©×™×—×”.
         * @param {Object} message - ××•×‘×™×™×§×˜ ×”×•×“×¢×” ×-chatHistory.
         * @param {boolean} useTypingEffect - ×”×× ×œ×”×©×ª××© ×‘××¤×§×˜ ×”×§×œ×“×”.
         */
        function addMessage(message, useTypingEffect = false) {
            const role = message.role;
            const text = message.parts[0].text;
            const sources = message.sources || [];
            const type = message.type || 'text'; // 'text' ××• 'error'

            const messageContainer = document.createElement('div');
            messageContainer.className = `flex gap-x-4 ${role === 'user' ? 'justify-end' : 'justify-start items-start'}`;

            const bubble = document.createElement('div');
            const isError = type === 'error';
            
            // ×‘××¦×‘ API ×œ× ×—×•×§×™, × ×¦×™×’ ×©×’×™××” ×¢× ×¨×§×¢ ×¦×”×•×‘
            const errorClass = !isAPIReady ? 'bg-yellow-600 text-white' : 'bg-red-600 text-white';
            
            if (isError) {
                bubble.className = `max-w-3xl shadow-md p-4 rounded-xl ${errorClass} transition-all duration-300`;
            } else {
                bubble.className = `max-w-3xl shadow-md transition-all duration-300 ${role === 'model' ? 'darwin-bubble' : 'user-bubble p-4 rounded-xl'}`;
            }

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'flex flex-col max-w-3xl';
            contentWrapper.appendChild(bubble);

            if (role === 'model' || isError) {
                const avatarTemplate = document.getElementById('darwin-avatar-template');
                const avatar = avatarTemplate ? avatarTemplate.cloneNode(true) : document.createElement('div');
                
                if (avatarTemplate) {
                    avatar.classList.remove('hidden'); 
                    avatar.removeAttribute('id'); 
                }
                messageContainer.appendChild(avatar);
            
                if (useTypingEffect && !isError) {
                    typeTextEffect(bubble, text);
                } else {
                    bubble.innerHTML = text.replace(/\n/g, '<br>');
                }

                if (sources.length > 0 && !isError) {
                    const sourcesContainer = document.createElement('div');
                    sourcesContainer.className = 'w-full mt-1 source-text';
                    let sourcesHtml = '<p class="font-bold mb-1 text-teal-800">××§×•×¨×•×ª ×©×©×™××©×• ××ª ×“×¨×•×•×™×Ÿ:</p><ul class="list-none space-y-0.5">';

                    sources.forEach((source, index) => {
                        sourcesHtml += `<li><a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="text-blue-700 hover:text-blue-900 hover:underline transition-colors">${index + 1}. ${source.title || source.uri}</a></li>`;
                    });
                    sourcesHtml += '</ul>';

                    sourcesContainer.innerHTML = sourcesHtml;
                    contentWrapper.appendChild(sourcesContainer);
                }

            } else {
                bubble.innerHTML = text.replace(/\n/g, '<br>');
            }

            messageContainer.appendChild(contentWrapper);
            chatArea.appendChild(messageContainer);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        /**
         * ××•×—×§ ×•××¦×™×™×¨ ××—×“×© ××ª ×›×œ ×”×©×™×—×” ××”×–×™×›×¨×•×Ÿ ×”××§×•××™
         */
        function renderChatHistory() {
            chatArea.innerHTML = ''; 

            if (chatHistory.length === 0) {
                 const welcomeMessage = {
                    role: 'model',
                    parts: [{ text: "××”×œ×Ÿ ×•×‘×¨×•×›×™× ×”×‘××™×! ğŸ‘‹\n×ª×¨××•, ×›×©×”×™×™×ª×™ ×¦×¢×™×¨ ×•×¡×§×¨×Ÿ ×¢×œ ×¡×¤×™× ×ª '×”×‘×™×’×œ', ×œ× ×—×œ××ª×™ ×¢×œ ×›×œ ×”×™×“×¢ ×”×–×”. ×× ×™ ×›××Ÿ ×›×“×™ ×œ×—×œ×•×§ ××ª×›× ××ª ×¤×œ××™ ×¢×•×œ× ×”×˜×‘×¢, ××©×•×œ×‘×™× ×‘×ª×’×œ×™×•×ª ×”×’× ×˜×™×§×” ×”××•×“×¨× ×™×•×ª. ğŸ§¬\n\n×©××œ×• ××•×ª×™ ×›×œ ×©××œ×” ×©×™×© ×œ×›× ×¢×œ ×”×‘×¨×™×¨×” ×”×˜×‘×¢×™×ª, ×”×ª×××”, ××• ××¤×™×œ×• ×¢×œ ×”×¤×™× ×¦'×™× ×”× ×”×“×¨×™× ×©×œ ×’×œ××¤×’×•×¡! ğŸ¦ ×× ×™ ×›×‘×¨ ××¦×¤×” ×œ×’×œ×•×ª ××” ××¢× ×™×™×Ÿ ××ª×›×! ğŸ§" }],
                };
                addMessage(welcomeMessage, true); 
            } else {
                chatHistory.forEach(msg => addMessage(msg, false)); 
            }
        }

        /**
         * ×× ×’× ×•×Ÿ Backoff ×œ×‘×™×¦×•×¢ ×§×¨×™××ª API.
         */
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                             throw new Error(`Server error: ${response.status}`);
                        }
                    }
                    return response;
                } catch (error) {
                    if (attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error("API call failed after multiple retries.");
                    }
                }
            }
        }

        /**
         * ×©×•×œ×— ××ª ×”×”×•×“×¢×” ×œ××•×“×œ Gemini ×•××¢×“×›×Ÿ ××ª localStorage.
         */
        async function sendMessage(event) {
            event.preventDefault();
            const userQuery = userInput.value.trim();

            // ×× ×”-API ×œ× ××•×›×Ÿ (××¤×ª×— ×—×¡×¨), ××•× ×¢×™× ×©×œ×™×—×”
            if (!userQuery || !isAPIReady) {
                 if (!isAPIReady) {
                    // ×”×•×¡×¤×ª ×”×•×“×¢×ª ×©×’×™××” ××•×“×’×©×ª ×œ××©×ª××©
                    const errorMsgObj = { 
                        role: "model", 
                        parts: [{ text: "âŒ ××™×Ÿ ×œ×™ ××¤×ª×— API! ×”×•×¡×£ ××ª ×”××¤×ª×— ×©×œ×š ×œ×§×•×“ (××©×ª× ×” USER_API_KEY) ×›×“×™ ×©××•×›×œ ×œ×”×ª×—×‘×¨ ×œ×’×•×’×œ." }], 
                        type: 'error', 
                        timestamp: new Date().getTime() 
                    };
                    chatHistory.push(errorMsgObj);
                    // ×¢×“×›×•×Ÿ: ××™×Ÿ ×¦×•×¨×š ×œ×©××•×¨ ××ª ×”×”×™×¡×˜×•×¨×™×” ×”××§×•××™×ª
                    renderChatHistory();
                 }
                 return;
            }

            // 1. ×”×•×¡×¤×ª ×”×•×“×¢×ª ×”××©×ª××© ×œ×–×™×›×¨×•×Ÿ ×”××§×•××™
            const userMessage = { role: "user", parts: [{ text: userQuery }], timestamp: new Date().getTime() };
            chatHistory.push(userMessage); 
            
            // 2. ×©××™×¨×ª ×”×™×¡×˜×•×¨×™×” ××§×•××™×ª (×œ××—×¨ ×”×•×¡×¤×ª ×”×•×“×¢×ª ×”××©×ª××©) - × ×˜×¨×œ× ×• ××ª ×”×©××™×¨×” ×‘×¤×•×¢×œ
            saveHistoryToLocalStorage();
            renderChatHistory();
            
            // 3. × ×¢×™×œ×ª UI ×•×”×¦×’×ª ×˜×¢×™× ×”
            userInput.value = '';
            userInput.disabled = true;
            sendButton.disabled = true;
            loadingIndicator.classList.remove('hidden'); 
            
            
            // 4. ×”××©×š ×œ×•×’×™×§×ª API ×¨×’×™×œ×”
            const apiHistory = chatHistory.map(msg => ({ 
                role: msg.role === 'model' ? 'model' : 'user', 
                parts: msg.parts 
            }));

            const payload = {
                contents: apiHistory,
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPromptHebrew }]
                },
            };

            let result;
            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                result = await response.json();
                
                const candidate = result.candidates?.[0];
                const text = candidate?.content?.parts?.[0]?.text;
                let darwinMessage;

                if (text) {
                    // 4×. ×”×¦×œ×—×”: ×‘× ×™×™×ª ×”×•×“×¢×ª ×“×¨×•×•×™×Ÿ
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;

                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    
                    darwinMessage = { role: "model", parts: [{ text: text }], sources: sources, timestamp: new Date().getTime() };

                } else {
                    // 4×‘. ×›×™×©×œ×•×Ÿ: ×”×•×“×¢×ª ×©×’×™××”
                    let errorMessage = "×¡×œ×™×—×”, × ×¨××” ×©×›×¨×’×¢ ×× ×™ ×¢×¡×•×§ ×‘××—×§×¨ ×¢×œ ×™×•× ×™×. × ×¡×” ×œ×©××•×œ ×©×•×‘ ×‘×‘×§×©×”. ğŸ¦";

                    if (candidate && candidate.finishReason === 'SAFETY') {
                        errorMessage = "××‘×•×™! ××©×”×• ×‘××—×§×¨ ×”× ×•×›×—×™ ×©×œ×™ × ×ª×§×œ ×‘×¤×§×§ '×‘×˜×™×—×•×ª' ×©×œ ×”××•×“×œ. × ×¡×” ×œ×©××•×œ ×©××œ×” ××—×¨×ª ×‘× ×•×©× ××‘×•×œ×•×¦×™×”. ğŸ›¡ï¸";
                    } else if (result.error) {
                        errorMessage = `×ª×§×œ×ª API: ${result.error.message}. × ×¡×” ×œ×¨×¢× ×Ÿ ×•×œ×©××•×œ ×©×•×‘.`;
                    }
                    
                    darwinMessage = { role: "model", parts: [{ text: errorMessage }], type: 'error', timestamp: new Date().getTime() };
                    console.error("API Response Lacked Content or Failed:", JSON.stringify(result, null, 2)); 
                }

                // 4×’. ×¢×“×›×•×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×”×¦'××˜ ×•×©××™×¨×” ×œ-localStorage - × ×˜×¨×œ× ×• ××ª ×”×©××™×¨×” ×‘×¤×•×¢×œ
                chatHistory.push(darwinMessage);
                saveHistoryToLocalStorage();
                
            } catch (error) {
                // 4×“. ×˜×™×¤×•×œ ×‘×©×’×™××ª API ×§×¨×™×˜×™×ª (Network)
                const errorMessage = "××‘×•×™! ××©×”×• ×”×©×ª×‘×© ×‘×“×¨×š ×××™×™ ×’×œ××¤×’×•×¡. ××•×œ×™ × × ×¡×” ×œ×©×œ×•×— ××ª ×”×©××œ×” ×©×•×‘? ğŸ¤¯";
                
                const errorMsgObj = { role: "model", parts: [{ text: errorMessage }], type: 'error', timestamp: new Date().getTime() };
                chatHistory.push(errorMsgObj);
                saveHistoryToLocalStorage();
                
                console.error("Critical Error during sendMessage:", error);
            } finally {
                // 5. ×©×—×¨×•×¨ UI
                loadingIndicator.classList.add('hidden');
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
                
                renderChatHistory(); // ×•×“× ×¨× ×“×•×¨ ××—×¨×•×Ÿ ×©×œ ×”×”×™×¡×˜×•×¨×™×”
                // × ×§×” ××ª ×”×™×¡×˜×•×¨×™×™×ª ×”×¦'××˜ ×”××§×•××™×ª ××™×“ ×œ××—×¨ ×”×¦×’×ª ×”×ª×©×•×‘×” 
                // ×›×“×™ ×œ×”×‘×˜×™×— ×©×‘×¤×¢× ×”×‘××” ×©×ª×¨×¢× ×Ÿ, ×œ× ×ª×™×©××¨ ×”×™×¡×˜×•×¨×™×” (×œ××¨×•×ª ×©×”-save/load ×›×‘×•×™×™×, ×–×” ×œ×™×ª×¨ ×‘×™×˜×—×•×Ÿ).
                // ×©×™× ×œ×‘: ×–×” ×× ×§×” ×¨×§ ××ª ×”×”×™×¡×˜×•×¨×™×” ×”××§×•××™×ª, ×œ× ××ª ×”×”×™×¡×˜×•×¨×™×” ×‘×–××Ÿ ×”×©×™×—×” ×”× ×•×›×—×™×ª.
                // ×× ××ª×” ×¨×•×¦×” ×©×”×©×™×—×” ×ª×ª×—×™×œ ××—×“×© *××—×¨×™ ×›×œ ×©××œ×”*, ×ª×¦×˜×¨×š ×œ××¤×¡ ××ª chatHistory = [] ×›××Ÿ.
                // ×× ×™ ××©××™×¨ ××ª ×–×” ×›×š, ×¨×§ × ×˜×¨×•×œ ×©×œ ×”×©××™×¨×” ×‘×™×Ÿ ×¨×™×¢× ×•× ×™×.
            }
        }

        /**
         * ×¤×•× ×§×¦×™×™×ª ×”××ª×—×•×œ ×”×¨××©×™
         */
        function initializeAppLogic() {
            loadHistoryFromLocalStorage();
            renderChatHistory(); // ××¦×™×’ ××ª ×”×•×“×¢×ª ×”×¤×ª×™×—×”

            // ×‘×“×™×§×ª ××¤×ª×— API
            if (USER_API_KEY.trim() === "") {
                isAPIReady = false;
                userInput.disabled = true;
                sendButton.disabled = true;
                
                statusMessage.className = "mt-2 text-sm text-yellow-800 text-center font-bold bg-yellow-100 p-1 rounded";
                statusMessage.innerHTML = `
                    âš ï¸ ×“×¨×•×•×™×Ÿ × ×“×¨×© ×œ××¤×ª×— API! âš ï¸
                    ×¢×œ×™×š ×œ×¢×¨×•×š ××ª ×”×§×•×‘×¥ ×•×œ×”×“×‘×™×§ ××ª ××¤×ª×— Gemini API ×©×œ×š ×‘××§×•× ×”××™×•×¢×“
                    (×”××©×ª× ×” <code>USER_API_KEY</code>) ×›×“×™ ×œ××¤×©×¨ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.
                `;
            } else {
                isAPIReady = true;
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${USER_API_KEY}`;
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
                
                statusMessage.className = "mt-2 text-sm text-green-700 text-center font-bold";
                statusMessage.textContent = "âœ… ××—×•×‘×¨ ×œ××•×“×œ Gemini ×•×—×™×¤×•×© ×’×•×’×œ. ××•×›×Ÿ ×œ×¦××ª ×œ×“×¨×š! â›µ";
            }
        }

        // --- ××ª×—×•×œ ×•×”×•×¡×¤×ª ×××–×™× ×™ ××™×¨×•×¢×™× ---
        
        chatForm.addEventListener('submit', sendMessage);
        
        window.onload = initializeAppLogic;

    </script>
</body>
</html>